#!/bin/sh

set -e

CONF=/etc/barbican/barbican-api.conf
API_CONF=/etc/barbican/barbican-api-paste.ini

#PKGOS-INCLUDE#

if [ "$1" = "configure" ] || [ "$1" = "reconfigure" ] ; then
	. /usr/share/debconf/confmodule
	. /usr/share/dbconfig-common/dpkg/postinst

	pkgos_var_user_group barbican
	mkdir -p /var/lib/barbican/temp
	chown barbican:barbican /var/lib/barbican/temp

        pkgos_write_new_conf barbican barbican-api.conf
        pkgos_write_new_conf barbican barbican-api-paste.ini
	pkgos_write_new_conf barbican barbican-admin-paste.ini
	pkgos_write_new_conf barbican barbican-functional.conf
	pkgos_write_new_conf barbican policy.json
	mkdir -p /etc/barbican/vassals
	chown barbican:barbican /etc/barbican/vassals
	pkgos_write_new_conf barbican vassals/barbican-admin.ini
	pkgos_write_new_conf barbican vassals/barbican-api.ini

        db_get barbican/configure_db
        if [ "$RET" = "true" ]; then
                pkgos_dbc_postinst ${CONF} DEFAULT sql_connection barbican $@
        fi

        pkgos_rabbit_write_conf ${CONF} DEFAULT barbican
        pkgos_write_admin_creds ${API_CONF} filter:keystone_authtoken barbican

	db_get barbican/configure_db
	if [ "$RET" = "true" ]; then
		echo "Now calling barbican-db-manage upgrade: this may take a while..."
		echo "TODO: barbican-db-manage upgrade: Disabled for now..."
#		su -s /bin/sh -c 'barbican-db-manage upgrade' barbican
	fi

	db_stop
fi

#DEBHELPER#

exit 0
